# intelligent-pension-system--vision

### BJTU软件学院2024暑期实训小组作业

## 项目概述

这是智慧养老系统的算法部分，详细介绍如下。

## 技术栈
- 编程语言：Python
- 框架：pytorch
- 计算机视觉：OpenCV

## 依赖介绍
- fall,fire,invasion使用的各个依赖版本如下：
| Package                | Version          |
|------------------------|------------------|
| asttokens              | 2.4.1            |
| backcall               | 0.2.0            |
| certifi                | 2024.6.2         |
| charset-normalizer     | 3.3.2            |
| colorama               | 0.4.6            |
| contourpy              | 1.1.1            |
| cycler                 | 0.12.1           |
| decorator              | 5.1.1            |
| easydict               | 1.9              |
| executing              | 2.0.1            |
| filelock               | 3.15.4           |
| fonttools              | 4.53.0           |
| fsspec                 | 2024.6.1         |
| gitdb                  | 4.0.11           |
| GitPython              | 3.1.43           |
| idna                   | 3.7              |
| importlib_resources    | 6.4.0            |
| imutils                | 0.5.4            |
| intel-openmp           | 2021.4.0         |
| ipython                | 8.12.3           |
| jedi                   | 0.19.1           |
| Jinja2                 | 3.1.4            |
| kiwisolver             | 1.4.5            |
| MarkupSafe             | 2.1.5            |
| matplotlib             | 3.7.5            |
| matplotlib-inline      | 0.1.7            |
| mkl                    | 2021.4.0         |
| mpmath                 | 1.3.0            |
| networkx               | 3.1              |
| numpy                  | 1.24.4           |
| opencv-python          | 4.10.0.84        |
| packaging              | 24.1             |
| pandas                 | 2.0.3            |
| parso                  | 0.8.4            |
| pickleshare            | 0.7.5            |
| pillow                 | 10.3.0           |
| pip                    | 24.0             |
| prompt_toolkit         | 3.0.47           |
| psutil                 | 6.0.0            |
| pure-eval              | 0.2.2            |
| py-cpuinfo             | 9.0.0            |
| Pygments               | 2.18.0           |
| pyparsing              | 3.1.2            |
| python-dateutil        | 2.9.0.post0      |
| pytz                   | 2024.1           |
| PyYAML                 | 6.0.1            |
| requests               | 2.32.3           |
| scipy                  | 1.10.1           |
| seaborn                | 0.13.2           |
| setuptools             | 65.6.3           |
| six                    | 1.16.0           |
| smmap                  | 5.0.1            |
| stack-data             | 0.6.3            |
| sympy                  | 1.12.1           |
| tbb                    | 2021.13.0        |
| thop                   | 0.1.1.post2209072238 |
| torch                  | 2.2.2            |
| torchaudio             | 2.3.1+cu118      |
| torchvision            | 0.17.2           |
| tqdm                   | 4.66.4           |
| traitlets              | 5.14.3           |
| typing_extensions      | 4.12.2           |
| tzdata                 | 2024.1           |
| ultralytics            | 8.2.48           |
| ultralytics-thop       | 2.0.0            |
| urllib3                | 2.2.2            |
| wcwidth                | 0.2.13           |
| wheel                  | 0.43.0           |
| zipp                   | 3.19.2           |
| **Python Version**     | **3.8.19**       |

## 算法描述

### 3.4.1 实时情感分析

**（具体描述待补充）**

### 3.4.2 摔倒事件检测

**算法概述**  
摔倒事件检测算法用于检测是否有人出现摔倒状态，如果连续30帧保持摔倒状态则记录为摔倒。输入为摄像头的实时视频，输出为经过算法处理后的每一帧，每一帧上面标注了所有检测为摔倒或者没摔倒的人体。

**输入输出**  
1. 输入:
   - 源数据（source）：设备摄像头（webcam）
   - 权重文件（weights）：训练后最优的YOLOv5模型权重文件，best.pt
   - 图像大小（imgsz）：推理时的图像尺寸。
   - 置信度阈值（conf_thres）：检测框的置信度阈值。
   - NMS阈值（iou_thres）：非极大值抑制的IOU阈值。
   - 最大检测数（max_det）：每张图像的最大检测数。

2. 输出:
   - 处理过后的视频帧：包含检测框和类别标签。
   - 摔倒截图图片：检测到摔倒后进行截图的结果图片，不含检测框和类别标签，但是有“老人摔倒啦”的提示字样在图片上。

**算法流程**  
1. 初始化与参数解析:
   - 从命令行解析输入参数。
   - 检查并设置权重文件、源数据、数据集配置文件等。
2. 加载模型:
   - 根据输入的权重文件加载YOLOv5模型。
   - 配置模型的推理设备（CPU或GPU）。
3. 数据加载:
   - 根据摄像头加载数据。
   - 设置数据加载的相关参数，如图像大小、批处理大小等。
4. 模型推理:
   - 对每张图像或视频帧进行预处理。
   - 使用YOLOv5模型进行推理，得到初步检测结果。
   - 进行非极大值抑制（NMS）处理，去除冗余的检测框。
5. 结果处理与保存:
   - 将检测结果进行后处理，如缩放检测框到原图尺寸、标注检测框等。
   - 将截图进行保存。
6. 日志记录与结果输出:
   - 记录视频帧的检测结果和推理时间。
   - 输出检测结果保存路径和日志信息。

**数据结构与变量**  
- weights: YOLOv5模型的权重文件路径。
- source: 源数据路径，可以是文件、目录、URL等。
- imgsz: 推理时的图像尺寸（高度和宽度）。
- conf_thres: 检测框的置信度阈值。
- iou_thres: 非极大值抑制的IOU阈值。
- max_det: 每张图像的最大检测数。
- device: 使用的计算设备，如CPU或CUDA设备。
- classes: 需要过滤的类别。
- agnostic_nms: 是否进行类别无关的NMS处理。
- augment: 是否进行增强推理。
- visualize: 是否可视化特征。
- project: 结果保存的项目路径。
- name: 结果保存的项目名称。
- exist_ok: 是否覆盖已存在的项目名称。
- line_thickness: 检测框的线条粗细。
- hide_labels: 是否隐藏标签。
- hide_conf: 是否隐藏置信度。
- half: 是否使用FP16半精度推理。
- dnn: 是否使用OpenCV DNN进行ONNX推理。
- vid_stride: 视频帧率步幅。

### 3.4.3 陌生人识别与追踪

**（具体描述待补充）**

### 3.4.4 禁止区域入侵检测

**算法概述**  
该禁止区域入侵检测算法通过视频监控实时检测并识别物体进入预设禁止区域的情况。利用YOLOv5进行目标检测，只对车辆和行人进行检测，不检测和标注其他物体。前端传入的边框四点坐标位置在视频帧上绘制禁止区域，并使用deep_sort跟踪检测到的目标是否进入该区域。一旦检测到入侵行为，系统会进行相应的处理或报警。

**输入输出**  
1. 输入:
   - 摄像头实时视频流
   - 禁止区域四点坐标

2. 输出:
   - 实时监控画面，显示检测到的目标和禁止区域
   - 检测到入侵后的截图

**算法流程**  
1. 初始化:
   - 打开摄像头。
   - 设置视频帧的宽度和高度。
   - 定义检测器对象 Detector。
2. 绘制禁止区域:
   - 获取前端传入的顶点坐标，调用draw_mask在视频帧上绘制禁止区域。
3. 目标检测与跟踪:
   - 读取视频帧并进行目标检测，得到目标的边界框 bboxes。
   - 更新目标跟踪器 tracker，跟踪目标并绘制目标边界框。
   - 判断目标是否进入禁止区域，若进入则标记入侵行为。
4. 显示与处理:
   - 在视频帧上显示检测结果和禁止区域。
   - 实时显示监控画面，按键退出检测。

**数据结构与变量**  
1. 变量:
   - point1，point2，point3，point4：禁止区域的四个顶点的坐标。
   - video：视频流对象。
   - frame_cnt：视频帧计数器。
   - dict_box 和 dic_id：用于目标跟踪的字典，存储目标的边界框信息和ID。

2. 函数:
   - draw_mask(im, point1, point2, point3, point4)：绘制禁止区域。
   - Detector.detect(im)：目标检测函数，返回检测结果。
   - tracker.update(bboxes, im, frame_cnt, dict_box, dic_id)：目标跟踪函数，更新目标状态。
   - tracker.draw_bboxes(im, listboxs, mask)：在视频帧上绘制目标边界框和禁止区域。

### 3.4.5 义工与老人交互检测

**（具体描述待补充）**

### 3.4.6 火灾检测

**算法概述**  
该火灾检测算法利用深度学习模型对视频流中的火灾进行实时检测。通过分析每一帧视频图像，识别出可能的火灾，并在检测到火灾时生成报警信息和截图，上传至云存储，同时记录检测到的火灾事件。

**输入输出**  
1. 输入:
   - 设备摄像头拍摄的实时视频流

2. 输出:
   - 实时监控画面，显示检测到的火灾区域
   - 火灾检测结果（如火灾事件的截图和报警信息）

**算法流程**  
1. 初始化:
   - 打开摄像头以获取视频流。
   - 设置视频帧的尺寸和颜色空间。
   - 定义火灾检测模型 model 并将其加载到指定设备（如CPU或GPU）。
2. 图像预处理:
   - 调整视频帧大小。
   - 转换图像颜色空间（BGR转RGB）。
   - 将图像转换为张量，并归一化处理。
3. 火灾检测:
   - 对预处理后的图像进行推理，得到检测结果。
   - 应用非极大值抑制（NMS）过滤多余的检测框。
   - 处理每个检测结果，确定是否为火灾。
4. 结果处理:
   - 如果检测到火灾，增加火灾计数器 fire_count。
   - 每隔10帧或第一次检测到火灾时，生成截图并保存。
   - 将截图上传至云存储，并记录火灾事件。
5. 显示与返回:
   - 在视频帧上绘制检测结果并显示。
   - 返回视频流，用于实时监控。

**数据结构与变量**  
1. 变量:
   - fire_count：火灾计数器，用于记录检测到的火灾次数。
   - camera：视频流对象。
   - frame：当前视频帧。
   - im：预处理后的图像张量。
   - im0：用于显示的原始视频帧。
   - pred：模型推理结果。
   - det：检测结果（每个边界框的信息）。
   - annotator：用于在图像上